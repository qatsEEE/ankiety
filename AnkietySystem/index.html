<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8" />
    <title>Ankieta</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Font & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

    <!-- tsParticles -->
    <script src="https://cdn.jsdelivr.net/npm/tsparticles@3/tsparticles.bundle.min.js"></script>

    <!-- SignalR -->
    <script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@8.0.0/dist/browser/signalr.min.js"></script>

    <style>
        body {
            margin: 0;
            min-height: 100vh;
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #0b001d 0%, #190032 100%);
            color: #fff;
            overflow: hidden;
        }
        #tsparticles {
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            z-index: 0;
        }
        #app-container {
            position: relative;
            z-index: 1;
            max-width: 700px;
            margin: 5vh auto;
            background: rgba(15,0,40,0.75);
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 0 30px 2px #2a004e99;
        }
        .option {
            margin: 1rem 0;
            background: rgba(255,255,255,0.07);
            padding: 1rem;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .option:hover {
            background: rgba(121, 40, 202, 0.25);
        }
        .bar-container {
            background: rgba(255,255,255,0.13);
            height: 8px;
            border-radius: 5px;
            margin-top: 0.5rem;
        }
        .bar {
            height: 100%;
            border-radius: 5px;
            background: linear-gradient(to right, #5f2d8a, #2e003e 80%);
            width: 0;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
<div id="tsparticles"></div>

<div id="app-container">
    <h1 id="poll-title">Ankieta</h1>
    <div id="poll-container">Ładowanie...</div>
</div>

<script>
    // tsParticles – konfiguracja inspirowana particles.js, czarne i ciemnofioletowe kulki + linie
    (async () => {
        await tsParticles.load("tsparticles", {
            background: { color: "#0b001d" },
            fpsLimit: 60,
            particles: {
                number: { value: 90, density: { enable: true, value_area: 900 } },
                color: { value: ["#6d3fa9", "#2e003e", "#0b001d", "#9d53ff"] },
                shape: { type: "circle" },
                opacity: {
                    value: 0.75,
                    random: true,
                    animation: { enable: false }
                },
                size: {
                    value: 3.5,
                    random: { enable: true, minimumValue: 1.2 }
                },
                links: {
                    enable: true,
                    distance: 140,
                    color: "#37225b",
                    opacity: 0.27,
                    width: 1.3
                },
                move: {
                    enable: true,
                    speed: 1.6,
                    direction: "none",
                    random: false,
                    straight: false,
                    outModes: { default: "out" },
                    attract: { enable: false }
                }
            },
            interactivity: {
                events: {
                    onHover: { enable: true, mode: "repulse" },
                    onClick: { enable: true, mode: "push" }
                },
                modes: {
                    repulse: { distance: 110, duration: 0.4 },
                    push: { quantity: 4 }
                }
            },
            detectRetina: true
        });
    })();

    // --- Ankiety API ---
    const apiUrl = "https://ankietyapi-da.azurewebsites.net/api";
    const pollId = 3; // <- zmień na ID nowej ankiety jeśli chcesz wyświetlać inną!

    const container = document.getElementById("poll-container");
    const title = document.getElementById("poll-title");
    let currentPollData = null;

    async function fetchAndRenderPoll() {
        container.innerHTML = "Ładowanie...";
        try {
            const resp = await fetch(`${apiUrl}/polls/${pollId}`);
            if (!resp.ok) {
                title.textContent = "Ankieta";
                container.innerHTML = `<p>Nie znaleziono ankiety lub błąd API.</p>`;
                return;
            }
            currentPollData = await resp.json();
            title.textContent = currentPollData.Question || "Ankieta";
            renderOptions();
        } catch (err) {
            title.textContent = "Ankieta";
            container.innerHTML = `<p>Błąd ładowania danych.</p>`;
            console.error('Failed to fetch poll:', err);
        }
    }

    function renderOptions() {
        if (!currentPollData) return;
        const total = currentPollData.Options.reduce((s, o) => s + o.Votes, 0);
        let html = "";
        currentPollData.Options.forEach(opt => {
            const pct = total ? ((opt.Votes/total)*100).toFixed(1) : 0;
            html += `
              <div class="option" onclick="vote(${opt.Id})" id="opt-${opt.Id}">
                <strong>${opt.Text}</strong>
                <div>${opt.Votes} głosów (${pct}%)</div>
                <div class="bar-container"><div class="bar" style="width:${pct}%"></div></div>
              </div>`;
        });
        container.innerHTML = html;
    }

    // Głosowanie (publiczne)
    async function vote(id) {
        const el = document.getElementById(`opt-${id}`);
        if (el) el.style.pointerEvents = "none";
        try {
            await fetch(`${apiUrl}/polls/vote`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ OptionId: id })
            });
        } catch (e) {
            console.error(e);
        }
        // Dodaj odświeżenie, jeśli SignalR się nie połączył
        setTimeout(() => {
            if (el) el.style.pointerEvents = "auto";
            fetchAndRenderPoll();
        }, 1000);
    }

    // SignalR – realtime update
    const conn = new signalR.HubConnectionBuilder()
        .withUrl(`${apiUrl}/negotiate`)
        .withAutomaticReconnect()
        .build();

    conn.on("newVote", (signalPollId, optionId, newVotes) => {
        if (!currentPollData || signalPollId !== currentPollData.Id) return;
        const option = currentPollData.Options.find(o => o.Id === optionId);
        if (option) {
            option.Votes = newVotes;
            renderOptions();
        }
    });

    (async () => {
        try {
            await conn.start();
            console.log("Połączono z SignalR");
            fetchAndRenderPoll();
        } catch (e) {
            console.error("Błąd połączenia z SignalR:", e);
            fetchAndRenderPoll();
        }
    })();
</script>
</body>
</html>